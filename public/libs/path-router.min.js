const t={BeforeOpen:"beforeopen",AfterOpen:"afteropen",BeforeClose:"beforeclose",AfterClose:"afterclose",Refresh:"refresh"},e=(e=HTMLElement)=>class extends e{currentProcess=Promise.resolve();canBeOpened=async()=>!0;canBeClosed=async()=>!0;getProperties(){return Object.entries(this.dataset).reduce((t,e)=>{const i=e[0];if(!i.startsWith(u))return t;const s=i[u.length].toLowerCase()+i.substring(u.length+1),r=e[1];return t[s]=r,t},{})}async enter(t){return await this.canBeOpened()?(this.currentProcess=this.#t(t),await this.currentProcess,this.currentProcess=Promise.resolve(),!0):(console.info("Navigation blocked by validity check."),!1)}async#t(e){this.dispatchEvent(new CustomEvent(t.BeforeOpen,{detail:{path:e,properties:this.getProperties()}})),await Promise.allSettled(this.#e.map(t=>t())),this.dataset.entering="",await Promise.allSettled(this.getAnimations({subtree:!0}).map(t=>t.finished)),delete this.dataset.entering,this.#i(),this.dispatchEvent(new Event(t.AfterOpen)),await Promise.allSettled(this.#s.map(t=>t()))}async#i(){this.toggleAttribute("open",!0),this.setAttribute("aria-current","page")}async exit(){return 0==await this.canBeClosed()?(console.info("Navigation blocked by validity check."),!1):(this.currentProcess=this.#r(),await this.currentProcess,this.currentProcess=Promise.resolve(),!0)}async#r(){this.dispatchEvent(new Event(t.BeforeClose)),await Promise.allSettled(this.#n.map(t=>t())),this.dataset.exiting="",this.removeAttribute("open"),await Promise.all(this.getAnimations({subtree:!0}).map(t=>t.finished)),this.#o(),delete this.dataset.exiting,this.dispatchEvent(new Event(t.AfterClose)),await Promise.allSettled(this.#a.map(t=>t()))}#o(){this.toggleAttribute("open",!1),this.removeAttribute("aria-current")}#e=[];#s=[];#n=[];#a=[];applyEventListener(e,i,s){const r=null!=this.getAttribute("open");this.addEventListener(e,i,s),e!=t.BeforeOpen.toString()&&e!=t.AfterOpen.toString()||1!=r?(e==t.BeforeClose.toString()||e==t.AfterClose.toString()&&0==r)&&this.dispatchEvent(new Event(e)):this.dispatchEvent(new Event(e))}addBlockingEventListener(e,i){switch(e){case t.BeforeOpen:this.#e.push(i);break;case t.AfterOpen:this.#s.push(i);break;case t.BeforeClose:this.#n.push(i);break;case t.AfterClose:this.#a.push(i)}}applyBlockingEventListener(e,i){const s=null!=this.getAttribute("open");this.addBlockingEventListener(e,i),e!=t.BeforeOpen.toString()&&e!=t.AfterOpen.toString()||1!=s?(e==t.BeforeClose.toString()||e==t.AfterClose.toString()&&0==s)&&this.dispatchEvent(new Event(e)):this.dispatchEvent(new Event(e))}},i="route-dialog";class s extends(e(HTMLDialogElement)){}null==customElements.get(i)&&customElements.define(i,s,{extends:"dialog"});const r="route-page";class n extends(e()){}null==customElements.get(r)&&customElements.define(r,n);const o={Change:"change",PathChange:"pathchange"},a=new CSSStyleSheet;a.replaceSync("/* \r\n   Animations will not be awaitable in code if they have a display of none.\r\n   Instead, the routes are stacked in a grid.\r\n */\r\npath-router\r\n,.route-view\r\n{ \r\n    display: var(--router-display, grid);\r\n    grid-template-columns: 1fr;\r\n    grid-template-rows: 1fr;\r\n}\r\n\r\nroute-page\r\n{\r\n    display: var(--route-display, block);\r\n    visibility: hidden;\r\n    grid-row: 1;\r\n    grid-column: 1;\r\n}\r\n/* \r\n   Visibility is visible during the entering and exiting phases\r\n   to allow for animations to be awaited.\r\n */\r\nroute-page[open]\r\n,route-page[data-entering]\r\n,route-page[data-exiting]\r\n{\r\n    visibility: visible;\r\n}\r\n\r\n/* sub routes should respect the visibility of the parent routes */\r\nroute-page:not([open],[data-entering],[data-exiting]) route-page[open]\r\n{\r\n    visibility: inherit;\r\n}");const l=new Promise(t=>{"complete"!==document.readyState?document.addEventListener("DOMContentLoaded",t):t(null)}),u="property",h="path-router";class c extends HTMLElement{get routePages(){return Array.from(this.querySelectorAll(`:scope > ${r}, ${h} :not(${h}) ${r}`),t=>t)}get routeDialogs(){return Array.from(this.querySelectorAll(`:scope > [is="${i}"]`),t=>t)}get routes(){return Array.from(this.querySelectorAll(`:scope > ${r},${h} :not(${h}) ${r},:scope > [is="${i}"]`),t=>t)}targetPageRoute;currentPageRoute;targetDialogRoute;currentDialogRoute;defaultRoute;get path(){return this.getAttribute("path")}set path(t){this.setAttribute("path",t)}#l;#u=[];#h;async navigate(t){return new Promise(e=>{this.#h=e,this.setAttribute("path",t)})}addRouteLinkClickHandlers(t,e="a[data-route],button[data-route]"){t=t??document.body,Array.isArray(t)||(t=[t]);for(let i=0;i<t.length;i++)t[i].addEventListener("click",s=>this.routeLink_onClick(t[i],s,e))}routeLink_onClick(t,e,i="a[data-route],button[data-route]"){if(1==e.defaultPrevented)return;let s=e.composedPath().find(t=>null!=t.dataset?.route);if(null!=s){const e=[...t.querySelectorAll(i)];for(let t=0;t<e.length;t++)e[t].removeAttribute("aria-current");let r=s.dataset.route;if(-1!=r.indexOf(":")){let t=s.closest('route-page,[is="route-dialog"]');for(;null!=t;){const e=t.getProperties(),i=r.split("/").filter(t=>t.startsWith(":"));for(let t=0;t<i.length;t++){const s=i[t].substring(1);null!=e[s]&&(r=r.replace(`:${s}`,e[s]))}t=t.parentElement?.closest('route-page,[is="route-dialog"]')}}if(r.startsWith("#")){const t=(this.path??"").split("#");t[1]=r.substring(1),r=t.join("#")}this.setAttribute("path",r),s.setAttribute("aria-current","page")}}getRouteProperties(t){if(null!=t)return t.getProperties();const e={};for(let t=0;t<this.routes.length;t++){const i=this.routes[t];Object.assign(e,i.getProperties())}return e}compareLocations(t,e){let i=!1,s=!1;return e.pathname!=t.pathname?i=!0:e.pathname==t.pathname&&e.hash!=t.hash&&(i=!0,""!=t.hash&&""!=e.hash&&(s=!0)),{hasChanged:i,isReplacementChange:s}}async#c(e,r){if(0==this.#g)throw new Error("Unable to update path-router before activation.");const a=e.startsWith("/")?e.substring(1):e,[l,u]=this.#p(a),[h,c]=this.#p(r);let g=!1,p=!1;const d=(""==u||""!=l)&&h!=l,f=u!=c,v=this.querySelector("[open]");if(0==d&&0==f&&null!=v)return null!=this.#h&&(this.#h(),this.#h=void 0),v.dispatchEvent(new CustomEvent(t.Refresh,{detail:{path:e},bubbles:!0,cancelable:!0})),[g,p];await this.#d();const b=this.#f(a);let m=b.filter(t=>t.route instanceof n);const P=b.filter(t=>t.route instanceof s);let R=new Promise(t=>t(!1));m=this.#v(m);let y=!1;const A=m.map(t=>t.route);if(1==d||null==v){if(0==await this.#b(A))return console.warn("Navigation was prevented."),console.info(`Requested path: ${e}`),null!=this.#h&&(this.#h(),this.#h=void 0),!1;y=!0;for(let t=0;t<m.length;t++){const e=m[t];R=this.#m(e.route,u),this.#P(e.route,e.properties)}}if(d||c!=u){if(0!=await this.#R(P.map(t=>t.route))){for(let t=0;t<P.length;t++){const e=P[t];if(p=await this.#y(e.route,u),this.#P(e.route,e.properties),0==y){const t=[...e.route.querySelectorAll("route-page")];for(let e=0;e<t.length;e++)A.indexOf(t[e])>-1||await t[e].exit()}}for(let t=0;t<m.length;t++){const e=m[t];null!=e.route.closest(`[is="${i}"][open]`)&&(R=this.#m(e.route,u),this.#P(e.route,e.properties))}}}return g=await R,this.targetPageRoute=void 0,this.targetDialogRoute=void 0,null!=this.#h&&(this.#h(),this.#h=void 0),this.dispatchEvent(new CustomEvent(o.PathChange,{detail:{sanitizedPath:a},bubbles:!0,cancelable:!0})),[g,p]}#p(t){const e=t.split("#"),i=e[0],s=t.length>1?e[1]:null,r=null==s?[""]:s.split("?");return[i,null==r?"":r[0]]}#f(t){const e=[],i=[];for(let r=0;r<this.routes.length;r++){const n=this.routes[r],[o,a]=this.routeMatchesPath(n,t,i,n instanceof s);1==o&&(e.push({route:n,properties:a}),i.push(n))}return e}#v(t){const e=[];for(let i=0;i<t.length;i++){const s=t[i],r=s.route.getAttribute("path"),n=s.route.parentElement?.closest('route-page,[is="route-dialog"],path-router'),o=t.find(t=>-1==e.indexOf(t)&&t!=s&&t.route.parentElement?.closest('route-page,[is="route-dialog"],path-router')==n);if(null==o)continue;if(r?.startsWith(":")){e.push(s);continue}const a=o.route.getAttribute("path");a?.startsWith(":")&&e.push(o)}return t.filter(t=>-1==e.indexOf(t))}async#d(){return Promise.allSettled(this.routes.map(t=>t.currentProcess))}async#m(t,e){if(this.targetPageRoute=t,this.targetPageRoute=this.targetPageRoute||this.defaultRoute,null==this.targetPageRoute)return!1;const i=await this.targetPageRoute.enter(e);return i&&(this.currentPageRoute=this.targetPageRoute,this.dispatchEvent(new CustomEvent(o.Change,{detail:{route:this.targetPageRoute,path:e}}))),i}async#y(t,e){if(this.targetDialogRoute=t,null==this.targetDialogRoute)return!1;const i=await this.targetDialogRoute.enter(e);return i&&(this.currentDialogRoute=this.targetDialogRoute,this.dispatchEvent(new CustomEvent(o.Change,{detail:{route:this.targetDialogRoute,path:e}}))),i}async#b(t){const e=this.routePages.filter(t=>"page"==t.getAttribute("aria-current"));let i=!0;for(let s=0;s<e.length;s++)t.indexOf(e[s])>-1||(i=0==i?i:await e[s].exit());return i}async#R(t){const e=this.routeDialogs.filter(t=>"page"==t.getAttribute("aria-current"));let i=!0;for(let s=0;s<e.length;s++)t.indexOf(e[s])>-1||(i=0==i?i:await e[s].exit());return i}#P(t,e){for(const[i,s]of Object.entries(e)){const e=u+i.substring(0,1).toUpperCase()+i.substring(1);t.dataset[e]=s}}routeMatchesPath(t,e,s,n=!1){const o=e.split("#"),a=o[0],l=o.length>1?o[1]:null,u=(t.getAttribute("path")??"").split("/"),h=a.split("/");if("Page"==(null==t.closest(`[is="${i}"]`)?"Page":"Dialog"))return this.routeTypeMatches(t,h,u,`${r}`,s);if(null==l)return[!1,{}];const c=l.split("/");return this.routeTypeMatches(t,c,u,`${r},[is="${i}"]`,s)}routeTypeMatches(t,e,i,s,r){if(1==e.length&&""==e[0].trim())return[1==i.length&&""==i[0].trim(),{}];const n=[];let o=t.parentElement?.closest(s);for(;null!=o;){if(-1==r.indexOf(o))return[!1,{}];n.push(o),o=o.parentElement?.closest(s)}const a=n.reverse().reduce((t,e,i)=>`${""==t?"":t+"/"}${e.getAttribute("path")??""}`,"").split("/");let l=[...e].filter((t,e)=>{const i=a[e],s=i?.startsWith(":");return!(1==s||i==t)}),{match:u,properties:h}=this.pathArraySelectsRouteArray(l,i);return[u,h]}pathArraySelectsRouteArray(t,e){let i={};if(e.length>t.length)return{match:!1,properties:i};let s=!1;for(let r=0;r<t.length;r++){const n=e[r],o=t[r];if(null==n)return{match:s,properties:i};if(0==n.startsWith(":")){if(n!=o)return{match:!1,properties:i}}else i[n.substring(1)]=o;s=!0}return{match:s,properties:i}}async connectedCallback(){this.#l=this.#A(),this.#w(),await this.#l,await this.#C(),null!=this.getAttribute("path")&&null==this.currentPageRoute&&null!=this.defaultRoute&&this.#m(this.defaultRoute,"")}disconnectedCallback(){this.#E()}#g=!1;async#A(){await l,this.#S(),this.#k(),this.#g=!0}#S(){this.defaultRoute=this.querySelector("route-page[default]"),null==this.defaultRoute&&(this.defaultRoute=this.querySelector("route-page"))}async#C(){for(let t=0;t<this.#u.length;t++)await this.#c(this.#u[t].newValue,this.#u[t].oldValue)}#O=this.#D.bind(this);#k(){for(let t=0;t<this.routeDialogs.length;t++)this.routeDialogs[t].addEventListener("close",this.#O)}async#D(t){const e=t.target;if(!(null!=e.getAttribute("data-exiting"))){const t=(this.getAttribute("path")??"/").split("#")[0];await this.navigate(t)}e.removeAttribute("data-exiting")}#E(){this.#x(),this.#B(),this.#l=void 0,this.#g=!1}#x(){null!=this.defaultRoute&&(this.defaultRoute=void 0)}#B(){this.removeEventListener("close",this.#O)}#w(){let t=this.getRootNode();-1==t.adoptedStyleSheets.indexOf(a)&&t.adoptedStyleSheets.push(a)}static observedAttributes=["path"];attributeChangedCallback(t,e,i){"path"==t&&(1==this.#g?this.#c(i,e??""):this.#u.push({newValue:i,oldValue:e??""}))}}null==customElements.get(h)&&customElements.define(h,c);export{h as COMPONENT_TAG_NAME,t as PathRouteEvent,c as PathRouterElement,o as PathRouterEvent,u as ROUTEPROPERTY_DATA_ATTRIBUTE_KEYWORD,s as RouteDialogElement,n as RoutePageElement,e as RouteType};
