<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Path Router Demo</title>
    <link rel="stylesheet" href="./demo-page.css">
    <link rel="stylesheet" href="./tabs.theme.css">
    <link rel="stylesheet" href="./heading-nav.theme.css">

    <style>
        main
        {
            display: grid;
        }
        browser-mockup::part(document)
        {
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body>
    <menu id="demo-pages">
        <a href="./index.html">Basic Routing</a>
        <a href="./browser-navigation.html">Browser Navigation</a>
        <a href="./active-browser-navigation.html">Active Browser Navigation</a>
        <a href="./transitions.html">Transitions</a>
        <a href="./themes.html">Themes</a>
    </menu>
    <div id="demo-content">
        <header>Browser Navigation</header>
        <div class="description">
            <p>This browser mockup demonstrates how the path-router element's navigation events can be handled. This demo page does not actually manipulate your browser's history.</p>
            <p>Instead, this demo collects the new path from the path-router element's "comparePath" function, and then applies it to the mockup.</p>
            <p>To see a demonstration that actually manipulates your browser's history, see <a href="./active-browser-navigation.html">the Active Browser Navigation demo</a>.</p>
        </div>
        <main>
            <browser-mockup url="https://www.path-router.com" tabs="1" collapsed-tabs="2" class="windows">
                <div class="layout" data-theme="heading-nav">
                    <menu id="page-menu">
                        <a is="route-link" for="page-router" data-theme="heading-nav" path="/">Routing</a>
                        <a is="route-link" for="page-router" data-theme="heading-nav" path="/user">User</a>
                        <a is="route-link" for="page-router" data-theme="heading-nav" path="/help">Help</a>
                        <a is="route-link" for="page-router" data-theme="heading-nav" path="/help/faq">FAQ</a>
                        <a is="route-link" for="page-router" data-theme="heading-nav" path="/help/contact">Contact</a>
                    </menu>
                    <path-router id="page-router" data-theme="heading-nav" >
                        <path-route path="/">
                            <h3>Routing</h3>
                            <p>Routes can define simple routes, nested routes, and dialog routes, which provide a secondary routing path for displaying dialogs over existing route content.</p>
                            <button type="button" is="route-button" for="page-router" data-theme="heading-nav" path="#about">Open Dialog Route</button>
                            <button type="button" is="route-button" for="page-router" data-theme="heading-nav" path="#about/website">Open Dialog Subroute</button>
                            <p>Routes can include variables by using a colon character before the variable name (ex: 'routeA/:id' defines the route variable of "id" for the "routeA" route).</p>
                            <button type="button" is="route-button" for="page-router" data-theme="heading-nav" path="/user/1">Open User 1</button>
                            <button type="button" is="route-button" for="page-router" data-theme="heading-nav" path="/user/2">Open User 2</button>
                            <button type="button" is="route-button" for="page-router" data-theme="heading-nav" path="/user/3">Open User 3</button>
                            <p>Nested routes can be linked to from top-level path-router elements by using variables.</p>
                            <button type="button" is="route-button" for="page-router" data-theme="heading-nav" path="/user/1/contact/alice">Open Alice Contact</button>
                            <button type="button" is="route-button" for="page-router" data-theme="heading-nav" path="/user/1/contact/bob">Open Bob Contact</button>
                            <button type="button" is="route-button" for="page-router" data-theme="heading-nav" path="/user/1/contact/bob/#address">Open Bob Contact's address</button>
                            <!-- Can't do this: -->
                            <!-- <a is="route-link" for="app-router" path="/help#about">Open About Dialog</a> -->
                            <!-- No automated way to know if the hash should be for the top level router, or a subrouter -->
                            <!-- Can move the dialog to top level and change link target router, or script from a page open event -->
                        </path-route>
                        <path-route path="/user/:id">
                            <h3>User</h3>
                            <p>Routes can be nested by adding a path-router element as a child of a path-route element.</p>
                            <nav>
                                <a is="route-link" for="user-router" data-theme="tabs" path=":id/profile">Profile</a>
                                <a is="route-link" for="user-router" data-theme="tabs" path=":id/contact">Contacts</a>
                            </nav>
                            <path-router id="user-router" data-theme="tabs">
                                <path-route path=":id/profile">
                                    <h4>User Profile</h4>
                                    <p>By giving the route a variable, like ":subpage", the remanining route can be passed down to the nested path-router element.</p>
                                </path-route>
                                <path-route path=":id/contact/:contactId">
                                    <path-router id="user-contact-router">
                                        <path-route path=":contactId/">
                                            <h4>User Contacts</h4>
                                            <p>Nested routes can also have path-router elements.</p>
                                            <p>By using variables and route-link elements, a nested path can be navigated to without any javascript needed for the implementer.</p>
                                            <nav>
                                                <style>
                                                    .link-button { padding: 0 .2em; cursor: pointer; }
                                                    .link-button:hover { text-decoration: underline ;}
                                                </style>
                                                <a is="route-link" for="user-contact-router" class="link-button" path="/alice">Alice</a>
                                                <a is="route-link" for="user-contact-router" class="link-button" path="/bob">Bob</a>
                                            </nav>
                                        </path-route>
                                        <path-route path="alice">
                                            <h4>Alice</h4>
                                            <p>Alice's Contact Info</p>
                                            <a is="route-link" for="user-contact-router" class="link-button" path="#address">See Address</a>
                                            <a is="route-link" for="user-contact-router" class="link-button" path="/">Back</a>
                                        </path-route>
                                        <path-route path="bob">
                                            <h4>Bob</h4>
                                            <p>Bob's Contact Info</p>
                                            <a is="route-link" for="user-contact-router" class="link-button" path="#address">See Address</a>
                                            <a is="route-link" for="user-contact-router" class="link-button" path="/">Back</a>
                                        </path-route>
                                        <dialog is="route-dialog" path="address">
                                            <h2>Contact Address</h2>
                                            <p>Contact Address Content</p>
                                            <form method="dialog"><button method="dialog">Close</button></form>
                                        </dialog>
                                    </path-router>
                                </path-route>
                            </path-router>
                        </path-route>
                        <path-route path="/help/:subpage">
                            <h2>Help</h2>
                            <nav>
                                <a is="route-link" for="help-router" data-theme="tabs" path="/faq">FAQ</a>
                                <a is="route-link" for="help-router" data-theme="tabs" path="/contact">Contact</a>
                            </nav>
                            <path-router id="help-router"data-theme="tabs">
                                <path-route path="/faq">
                                    <h3>Frequently Asked Questions</h3>
                                    <p>Answer Content</p>
                                </path-route>
                                <path-route path="/contact">
                                    <h3>Contact Us</h3>
                                    <p>Contact Content</p>
                                </path-route>
                            </path-router>
                        </path-route>
                        <dialog is="route-dialog" path="about/:subpage">
                            <h2>About</h2>
                            <p>About Content</p>
                            <nav>
                                <a is="route-link" for="about-router" data-theme="tabs" path="/company">Company</a>
                                <a is="route-link" for="about-router" data-theme="tabs" path="/website">Website</a>
                            </nav>
                            <path-router id="about-router">
                                <path-route path="company">
                                    <h3>About Company</h3>
                                    <p>About Company Content</p>
                                </path-route>
                                <path-route path="website">
                                    <h3>About Website</h3>
                                    <p>About Website Content</p>
                                    <button type="button" is="route-button" for="page-router" data-theme="heading-nav" path="#disclaimer">See Disclaimer</button>
                                </path-route>
                            </path-router>
                            <form method="dialog"><button method="dialog">Close</button></form>
                        </dialog>
                        <dialog is="route-dialog" path="disclaimer">
                            <h2>Disclaimer</h2>
                            <p>Disclaimer content</p>
                            <button type="button" is="route-button" for="page-router" data-theme="heading-nav" path="#about">Back to About</button>
                            <form method="dialog"><button method="dialog">Close</button></form>
                        </dialog>
                    </path-router>
                </div>
            </browser-mockup>
        </main>
    </div>
    <script type="module" src="./browser-mockup.js"></script>
    <script type="module" src="../dist/path-router.js"></script>
    <script type="module">
        import { PathRouterComponent } from '../dist/path-router.js';
        const browserMockup = document.body.querySelector('browser-mockup');
        const pageRouter = document.querySelector('#page-router');
        const userRouter = document.querySelector('#user-router');
        const userContactRouter = document.querySelector('#user-contact-router');
        const helpRouter = document.querySelector('#help-router');

        // nested dialog path explanation: all dialog routes would need to be accessible to the top level router
        // instead, just hook into the beforeopen event and open the dialog from the variable name 
        // route properties example
        
        // fix dialog subroute
        let historyIsUpdating = false;

        pageRouter.addEventListener('pathchange', pageRouter_onPathChange);
        function pageRouter_onPathChange(event)
        {
            // if we're moving back or forward,
            // we don't want to record that in history
            // and the browser will update the url
            if(historyIsUpdating == true) { return; } 
             
            const currentLocation = new URL(browserMockup.getAttribute('url')); // equivalent to `window.location`

            let updatedPath = pageRouter.composeRoutePath();
            // console.log(updatedPath);
            const origin = 'https://www.path-router.com' // reference window's origin with `window.location.origin`;
            const updatedLocation = new URL(origin + updatedPath);

            const { hasChanged, isReplacementChange } = pageRouter.compareLocations(currentLocation, updatedLocation);
            if(hasChanged)
            {
                if(isReplacementChange)
                {
                    browserMockup.history.replace(updatedLocation.href);
                }
                else
                {
                    browserMockup.history.add(updatedLocation.href);
                }
            }
        }

        const routeLinks = [...document.querySelectorAll('[is="route-link"],[is="route-button"]')];
        for(let i = 0; i < routeLinks.length; i++)
        {
            routeLinks[i].onPreparePath = prepareRouteLink;
        }
        function prepareRouteLink(path)
        {
            const url = browserMockup.getAttribute('url') ?? ""; // equivalent to `window.location.href`
            const urlParameters = PathRouterComponent.getUrlParameters(url);

            if(path.indexOf(':id') > -1)
            {
                const idValue = urlParameters.user;
                const id = parseInt(idValue);
                const userId = isNaN(id) ? -1 : id;
                if(userId > -1)
                {
                    path = path.replace(":id", userId);
                }
            }

            return path;
        }
        

        // equivalent to `window.addEventListener('popstate', [...])`;
        browserMockup.addEventListener('popstate', async (event) =>
        {
            historyIsUpdating = true;
            const location = new URL(browserMockup.getAttribute('url')) // reference the window's location with `window.location`;
            const path = location.pathname; // equivalent to `window.location.pathname`;
            const hash = location.hash; // equivalent to `window.location.hash`;
            const route = path + hash;
            await pageRouter.navigate(route);
            historyIsUpdating = false;
        });
    </script>
    <script type="module">
        // Setup code for mimicing browser history in mockup;
        // unreleated to path-router component

        const mockup = document.body.querySelector('browser-mockup');
        const backButton = mockup.shadowRoot.querySelector('[part="button-back"]');
        backButton.addEventListener('click', () =>
        {
            mockup.history.back();
        });
        const forwardButton = mockup.shadowRoot.querySelector('[part="button-forward"]');
        forwardButton.addEventListener('click', () =>
        {
            mockup.history.forward();
        });

        class History 
        {
            items = [mockup.getAttribute('url')];
            index = 0;

            add(value) 
            {
                this.index++;
                this.items[this.index] = value;
                mockup.setAttribute('url', this.items[this.index]);
                for(let i = this.items.length-1; i > this.index; i--)
                {
                    this.items.splice(i, 1);
                }
            }
            replace(value) 
            {
                this.items[this.index] = value;
                mockup.setAttribute('url', this.items[this.index]);
            }
            back()
            {
                if(this.index == 0) { return; }
                this.index = Math.max(this.index - 1, 0);
                mockup.setAttribute('url', this.items[this.index]);
                mockup.dispatchEvent(new Event('popstate'));
            }
            forward() 
            {
                if(this.index == this.items.length-1) { return; }

                this.index = Math.min(this.index + 1, this.items.length-1);
                mockup.setAttribute('url', this.items[this.index]);
                mockup.dispatchEvent(new Event('popstate'));
            }
        }
        mockup.history = new History();

    </script>
</body>
</html>